Time:2025-11-04

Tags:[distributed](3-tags/distributed.md)

## FaRM (Fast Remote Memory) 核心概念与设计思想学习笔记

| 模块 | 核心概念 (Key Concept) | 设计思想 (Design Philosophy) | 关键技术 (Core Technology) |
| :--- | :--- | :--- | :--- |
| **目标定位** | **高性能分布式事务** | 在**严格可串行化**、**高可用性**与**极致性能**之间取得平衡（不妥协）。 | 几十微秒的事务时间预算。 |
| **性能基石 (消除 I/O 瓶颈)** | **NVRAM (非易失性 RAM)** | **消除磁盘写入延迟**，将持久化写入从 100 µs (SSD) 降至 **200 ns** (RAM)。 | **UPS (电池) 供电的 RAM** + 断电时将 RAM 内容**快速写入 SSD**。 |
| **性能基石 (消除网络瓶颈)** | **RDMA (Remote Direct Memory Access)** | **消除 CPU 参与网络数据处理**的开销（系统调用、中断、拷贝、上下文切换）。 | **Kernel Bypass** + **单边 RDMA 读/写**（目标 CPU 不参与）。 |
| **并发控制** | **乐观并发控制 (OCC)** | **允许无锁、低延迟读取**（使用单边 RDMA），将冲突检测推迟到提交时。 | **版本号**（位于对象头）+ **锁标志**（版本号高位）进行原子检查和设置。 |
| **事务一致性** | **严格可串行化** | 确保**提交**的事务，其结果等同于某种串行执行顺序。 | **LOCK/VALIDATE** 阶段的**版本号检查**，冲突事务将**中止**。 |
| **数据持久化** | **主/备复制 (P/B) + NVRAM Log** | 确保即使在电源故障和单机崩溃（非独立）的情况下，已提交的数据也不会丢失。 | **LOCK** (Primary Log)、**COMMIT-BACKUP** (Backup Log)、**COMMIT-PRIMARY** (Primary Log) 三阶段写入 NVRAM。 |
| **事务提交点** | **COMMIT-PRIMARY 写入** | 提交点位于**第一个 COMMIT-PRIMARY 记录安全写入 Primary 的 NVRAM Log** 时。 | **RDMA 硬件 ACK** 作为持久化完成的信号。 |
| **数据模型** | **全内存分片 (Sharding)** | 必须将**所有数据**放入集群总 RAM 中，以避免任何磁盘 I/O。 | **Region/Object** 模型，通过 `<region #, address>` 进行寻址。 |
| **架构角色** | **TC/Primary/Backup/CM** | **TC** 充当 2PC 协调器（运行在服务器），**CM** (基于 ZK) 负责配置和故障恢复。 | 单数据中心内的主/备复制，**CM 跟踪配置**。 |

### 快速回顾总结

*   **FaRM 是什么？** 一个基于 **RDMA 和 NVRAM** 的**超高性能、严格可串行化**的分布式事务系统。
*   **如何实现极致性能？**
    *   **硬件加速 (RDMA + NVRAM)：** 绕过 CPU 和磁盘 I/O 瓶颈。
    *   **软件优化 (OCC)：** 允许**无锁单边 RDMA 读取**，避免了传统锁机制的延迟。
*   **如何保证一致性/持久性？**
    *   **一致性：** 乐观并发控制的**版本号验证**和**原子锁检查**。
    *   **持久性：** **NVRAM Log** 保证崩溃恢复，**主/备复制**保证高可用性。
*   **主要限制？** 依赖**特殊硬件**（RDMA、UPS-RAM）、**不适用于广域网**、**数据必须全在 RAM**、**冲突率高时性能急剧下降**。

# AI summarize

FaRM是微软设计的一个基于RDMA和NVRAM的高性能分布式事务系统，旨在通过硬件加速和乐观并发控制实现严格可串行化和微秒级事务延迟。关于FaRM，最值得记住的是它**革命性地结合RDMA和NVRAM硬件技术，彻底消除网络和存储I/O瓶颈，在分布式环境中实现接近本地内存的极致性能**。
# Reference
