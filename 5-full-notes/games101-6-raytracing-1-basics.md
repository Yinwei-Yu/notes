Time:2025-11-11

Tags:[cg](3-tags/cg.md)

# why ray tracing?

软阴影
Glossy reflection
Indirect illumination

准确,但是慢
光栅化:实时
光线追踪:离线

# 光线

1. 直线传播
2. 交叉光线不会碰撞
3. 光从光源到眼睛(可逆性)

# ray casting

1. 通过每个像素(成像平面)投射一条光线来生成图像
2. 通过向光源发送光线来检查阴影

eye point->eye ray->closest scene intersection point->link this point to the light(会不会被照亮)

算交点着色->写回像素

# whitted-style ray tracing

每根光线找到一个最近的点->有反射和折射光->计算弹射点是否被照亮

![](2-source-material/images/Pasted%20image%2020251111194125.png)

# Ray-Surface Intersection

## 光线

一个射线:
公式

r=o+td

## 球

方程联立:

判别式:

根据判别式判断交点个数

---

推广->光线和隐式表面的交点

f(o+td)=0

t需要为正实数

## 三角形mesh

一个个判断...找最小的t...太慢了

更好的办法->三角形在平面内->划分问题:

1. 光线和平面相交
2. 点在三角形内

---

平面的数学定义:

一个点和一个面的法线,公式:

here

判断点在平面内的方程式:

here is 公式...

交点判断:

光线方程代入p

然后判断交点是否在三角形内:叉乘

---

直接求光线和三角形交点?

MT算法
三角形用重心坐标描述->线性方程组->克莱尔法则

## 加速

使用包围盒

AABB包围盒(轴对齐包围盒)

---

光线和AABB求交? 先看二维

每个面可以求出光线进入和出去的时间->求交集

![](2-source-material/images/Pasted%20image%2020251111201226.png)

---

3d?

1. The ray enters the box only when it enters all pairs of slabs 
2. The ray exits the box as long as it exits any pair of slabs

每一对pair计算tmin和tmax

tenter = max{tmin}

texit = min{tmax}

if tentre < texit,则光线在盒子内待了一会,则一定有交点

负值处理:

1. texit<0->盒子在光线背后->没有交点
2. texit>0 but tenter<0 ->光线起点在盒子里->一定有交点

总结:光线和AABB有交点,iff:

tenter< texit and texit>0

---

为什么和坐标轴相交?

加速计算->减少了法线开销

# AI summarize

## 为什么需要光线追踪？

光线追踪技术主要解决传统光栅化难以处理的复杂光照效果：

**软阴影（Soft Shadows）**
- 由面光源产生，阴影边缘具有平滑过渡
- 传统硬阴影边界锐利，不符合真实世界观察
- 通过从表面点向光源区域发射多条光线计算遮挡程度

**光泽反射（Glossy Reflection）**
- 介于镜面反射和漫反射之间的反射效果
- 表面具有微粗糙度，反射图像略微模糊
- 典型例子：抛光金属、光滑塑料表面

**间接光照（Indirect Illumination）**
- 光线在场景中多次反弹产生的照明效果
- 包括颜色溢出（color bleeding）、环境光遮蔽等
- 对场景真实感贡献显著

**性能对比：**
- **光栅化（Rasterization）**：实时渲染，每秒30-60帧，适合游戏等交互应用
- **光线追踪（Ray Tracing）**：离线渲染，单帧可能需要数分钟到数小时，追求物理准确性

## 光线的基本性质

1. **直线传播**：在均匀介质中光线沿直线传播
2. **独立性原理**：交叉光线不会相互干扰，各自独立传播
3. **光路可逆性**：光线从光源到眼睛的路径与从眼睛到光源的路径相同，这是光线追踪算法的理论基础

## 光线投射（Ray Casting）

**基本流程：**
1. **生成主光线**：从相机位置（eye point）通过成像平面每个像素发射一条光线（eye ray）
2. **求交检测**：找到光线与场景中最近的交点（closest scene intersection point）
3. **阴影检测**：从交点向光源发射阴影光线，检测是否被遮挡
4. **着色计算**：根据光照模型计算交点颜色值
5. **像素写入**：将计算结果写入对应像素

**数学表示：**
对于每个像素 $p = (i, j)$，生成光线：
$$ \vec{r}(t) = \vec{o} + t\vec{d} $$
其中 $\vec{o}$ 为相机位置，$\vec{d}$ 为通过像素的标准化方向向量。

## Whitted风格光线追踪

在基础光线投射基础上增加递归反射和折射：

**递归过程：**
1. 从相机发射主光线，找到最近交点
2. 在交点处生成新的光线：
   - 反射光线（Reflection Ray）
   - 折射光线（Refraction Ray）
3. 对新光线重复求交过程，直到达到最大递归深度或光线能量衰减到阈值以下
4. 综合所有光线贡献计算最终颜色

![](2-source-material/images/Pasted%20image%2020251111194125.png)

**能量衰减：** 通常使用俄罗斯轮盘赌（Russian Roulette）或固定衰减系数控制递归深度。

## 光线-表面求交

### 光线数学表示

光线参数方程：
$$ \vec{r}(t) = \vec{o} + t\vec{d}, \quad t > 0 $$
其中：
- $\vec{o}$：光线起点（origin）
- $\vec{d}$：光线方向向量（direction），通常为单位向量
- $t$：沿光线方向的参数距离

### 球体求交

**球体隐式方程：**
$$ (\vec{p} - \vec{c})^2 - R^2 = 0 $$
其中 $\vec{c}$ 为球心，$R$ 为半径。

**联立求解：**
将光线方程代入球体方程：
$$ (\vec{o} + t\vec{d} - \vec{c})^2 - R^2 = 0 $$

展开得二次方程：
$$ (\vec{d} \cdot \vec{d})t^2 + 2\vec{d} \cdot (\vec{o} - \vec{c})t + (\vec{o} - \vec{c})^2 - R^2 = 0 $$

**判别式分析：**
$$ \Delta = [2\vec{d} \cdot (\vec{o} - \vec{c})]^2 - 4(\vec{d} \cdot \vec{d})[(\vec{o} - \vec{c})^2 - R^2] $$

- $\Delta > 0$：两个实根，两个交点
- $\Delta = 0$：一个实根，相切
- $\Delta < 0$：无实根，无交点

### 通用隐式表面求交

对于隐式表面 $f(\vec{p}) = 0$，求交问题转化为：
$$ f(\vec{o} + t\vec{d}) = 0 $$

求解满足 $t > 0$ 的实数解。

### 三角形网格求交

**朴素方法：** 遍历所有三角形，计算光线与每个三角形的交点，选择最小的正 $t$ 值。时间复杂度 $O(n)$，对于复杂场景效率低下。

**优化方法：** 将问题分解为两个子问题

#### 1. 光线-平面求交

**平面定义：**
由点 $\vec{p}_0$ 和法向量 $\vec{n}$ 定义：
$$ (\vec{p} - \vec{p}_0) \cdot \vec{n} = 0 $$

**交点求解：**
将光线方程代入平面方程：
$$ (\vec{o} + t\vec{d} - \vec{p}_0) \cdot \vec{n} = 0 $$

解得：
$$ t = \frac{(\vec{p}_0 - \vec{o}) \cdot \vec{n}}{\vec{d} \cdot \vec{n}} $$

要求 $\vec{d} \cdot \vec{n} \neq 0$（光线不与平面平行）且 $t > 0$。

#### 2. 点-三角形包含测试

使用重心坐标法或叉乘法判断交点是否在三角形内。

**叉乘法：**
对于三角形 $\triangle ABC$ 和点 $P$，检查：
$$ \vec{AB} \times \vec{AP}, \quad \vec{BC} \times \vec{BP}, \quad \vec{CA} \times \vec{CP} $$
如果三个叉积方向相同，则点在三角形内。

#### Möller-Trumbore算法

直接求解光线与三角形交点的优化算法：

**三角形重心坐标表示：**
$$ \vec{o} + t\vec{d} = (1 - u - v)\vec{A} + u\vec{B} + v\vec{C} $$

重新整理为线性系统：
$$ \begin{bmatrix}
-\vec{d} & \vec{B} - \vec{A} & \vec{C} - \vec{A}
\end{bmatrix}
\begin{bmatrix}
t \\ u \\ v
\end{bmatrix}
= \vec{o} - \vec{A} $$

使用克莱姆法则求解，只需一次矩阵运算即可得到 $t, u, v$。

## 加速结构

### 包围盒（Bounding Volume）

使用简单几何体包裹复杂物体，快速排除不可能相交的情况。

### AABB包围盒（轴对齐包围盒）

**定义：** 各面与坐标轴平面平行的长方体，由最小和最大坐标定义：
$$ [x_{min}, x_{max}] \times [y_{min}, y_{max}] \times [z_{min}, z_{max}] $$

### 光线-AABB求交算法

#### 二维情况分析

对于每个坐标轴方向的平面对：
- $x = x_{min}$ 和 $x = x_{max}$
- $y = y_{min}$ 和 $y = y_{max}$

计算光线进入和离开每个slab的时间：
$$ t_{x_{min}} = \frac{x_{min} - o_x}{d_x}, \quad t_{x_{max}} = \frac{x_{max} - o_x}{d_x} $$
$$ t_{enter_x} = \min(t_{x_{min}}, t_{x_{max}}), \quad t_{exit_x} = \max(t_{x_{min}}, t_{x_{max}}) $$

![](2-source-material/images/Pasted%20image%2020251111201226.png)

#### 三维扩展

**关键观察：**
1. 光线进入包围盒当且仅当它进入所有三对slab
2. 光线离开包围盒只要它离开任意一对slab

**算法步骤：**
1. 对每个坐标轴计算 $t_{enter}$ 和 $t_{exit}$
2. 总体进入时间：$t_{enter} = \max(t_{enter_x}, t_{enter_y}, t_{enter_z})$
3. 总体离开时间：$t_{exit} = \min(t_{exit_x}, t_{exit_y}, t_{exit_z})$
4. 相交条件：$t_{enter} < t_{exit}$ 且 $t_{exit} > 0$

**特殊情况处理：**
- $t_{exit} < 0$：包围盒在光线背后，无交点
- $t_{exit} \geq 0$ 且 $t_{enter} < 0$：光线起点在包围盒内，有交点

**完整判断条件：**
光线与AABB有交点当且仅当：
$$ t_{enter} < t_{exit} \quad \text{且} \quad t_{exit} > 0 $$

### 轴对齐的优势

- **计算简化**：法向量总是坐标轴方向，点积计算简化为单一坐标操作
- **内存友好**：只需存储最小和最大坐标值
- **构建快速**：容易从顶点数据计算包围盒

## AI 摘要补全

**光线追踪核心价值：** 通过模拟光线物理行为实现照片级真实感渲染，特别擅长处理全局光照效果。

**性能瓶颈与优化：** 求交计算占90%以上时间，加速结构（BVH、KD-tree等）是提升性能的关键。

**发展趋势：** 硬件光线追踪（RTX）、混合渲染（光栅化+光线追踪）成为实时图形新标准。

## 术语表

**光线追踪（Ray Tracing）**
- **定义**：通过模拟光线从相机出发在场景中传播路径来生成图像的渲染技术
- **应用**：电影特效、产品设计、建筑可视化等追求物理准确性的领域
- **相关概念**：路径追踪、光子映射、辐射度算法
- **变体**：Whitted风格、分布式光线追踪、路径追踪

**光栅化（Rasterization）**
- **定义**：将3D几何体投影到2D屏幕并确定每个像素颜色的渲染技术
- **应用**：实时图形、游戏、交互应用
- **相关概念**：深度测试、模板测试、多重采样抗锯齿
- **特点**：高性能但光照效果有限

**软阴影（Soft Shadows）**
- **定义**：由面光源产生的具有柔和边界的阴影效果
- **物理原理**：部分遮挡区域，umbra和penumbra区分
- **相关概念**：硬阴影、阴影映射、PCF（百分比渐进滤波）

**光泽反射（Glossy Reflection）**
- **定义**：表面微粗糙度导致的模糊反射效果
- **数学模型**：Cook-Torrance、GGX、Beckmann分布
- **相关概念**：镜面反射、漫反射、BRDF（双向反射分布函数）

**间接光照（Indirect Illumination）**
- **定义**：光线经过多次反弹后到达表面的照明
- **效果**：颜色溢出、环境光遮蔽、全局光照
- **计算方法**：辐射度、光子映射、路径追踪

**光线投射（Ray Casting）**
- **定义**：从相机通过每个像素发射单一光线的基础渲染算法
- **应用**：体积渲染、初步可见性测试
- **相关概念**：光线行进、体素化

**Whitted风格光线追踪**
- **定义**：支持完美镜面反射和折射的递归光线追踪算法
- **特点**：明确的反射和折射光线，有限递归深度
- **局限**：不支持漫反射互反射，可能产生噪声

**AABB（轴对齐包围盒）**
- **定义**：各面与坐标轴平面平行的长方体包围体积
- **应用**：碰撞检测、可见性剔除、光线求交加速
- **相关概念**：OBB（有向包围盒）、包围球、BVH（包围体积层次）

**Möller-Trumbore算法**
- **定义**：高效计算光线与三角形交点的算法
- **优势**：避免显式的平面求交和点包含测试
- **数学基础**：重心坐标、克莱姆法则

**重心坐标（Barycentric Coordinates）**
- **定义**：用三个权重系数表示点在三角形内位置的方法
- **性质**：$u + v + w = 1$，在三角形内时 $u,v,w \geq 0$
- **应用**：插值、纹理映射、点包含测试

**包围体积层次（BVH）**
- **定义**：递归地将场景分割为包围盒的树状结构
- **优势**：自适应场景分布，构建和遍历效率高
- **相关概念**：KD-tree、BSP-tree、表面积启发式
# Reference

[GAMES101_Lecture_13](2-source-material/slides/GAMES101_Lecture_13.pdf)