Time:2025-10-14

Status: 

- [ ] **working** ğŸ‘¨â€ğŸ’»
- [x] *done*    ğŸ’»

Tags:[[3-tags/distributed|distributed]]

## replicated state machines

å¤åˆ¶çŠ¶æ€æœºç”¨äºè§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®¹é”™é—®é¢˜ã€‚

é‡‡ç”¨å¤åˆ¶æ—¥å¿—çš„æ–¹å¼å®ç°ã€‚ï¼ˆåŒæ ·çš„èµ·å§‹çŠ¶æ€ï¼ŒåŒæ ·çš„è¾“å…¥->åŒæ ·çš„ç»“æœï¼‰

![[2-source-material/images/Pasted image 20251014090339.png]]

å…·ä½“å·¥ä½œ:clientå‘serverå‘èµ·è¯·æ±‚,serverå°†æ­¤è¯·æ±‚è®¾ç½®åˆ°logåˆ—è¡¨ä¸­,é€šè¿‡å…±è¯†ç®—æ³•ä¸å…¶ä»–serveräº¤æµ,å½“æ­¤logè¢«å¤§å¤šæ•°serverå¤åˆ¶å,serveråº”ç”¨æ­¤log,è¿”å›client.

å…±è¯†ç®—æ³•çš„å·¥ä½œä¸º:ä¿æŒå¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§

å…±è¯†ç®—æ³•é€šå¸¸æœ‰å¦‚ä¸‹æ€§è´¨:

1. åœ¨éæ‹œå åº­æƒ…å†µä¸‹,ä¿è¯å®‰å…¨æ€§(æ—¥å¿—ä¸€è‡´æ€§),å¦‚ç½‘ç»œå¯¼è‡´çš„åŒ…ä¸¢å¤±,é‡å¤,ä¹±åºç­‰.è¿™æ„å‘³ç€,å…±è¯†ç®—æ³•æ— æ³•è§£å†³æŸä¸€ä¸ªserverå‘é€æ¶æ„ä¿¡æ¯çš„æƒ…å†µ.
2. åªè¦å¤§å¤šæ•°æœåŠ¡å™¨å¯ç”¨,å…±è¯†ç®—æ³•å°±å¯ä»¥æ­£å¸¸å·¥ä½œ(2f+1å°æœºå™¨çš„å®¹é”™ä¸Šé™ä¸ºf)
3. ä¸ä¾èµ–æ—¶é’Ÿè¿›è¡ŒåŒæ­¥
4. æ™®éæƒ…å†µä¸‹,åªè¦å¤§å¤šæ•°serverå¤åˆ¶äº†log,logä¾¿å¯åº”ç”¨,ä¸€ä¸¤ä¸ªç¼“æ…¢çš„serverä¸ä¼šæ‹–æ…¢æ•´ä½“

## Raft basics

raftå°†å…±è¯†é—®é¢˜åˆ†ä¸ºä¸‰ä¸ªå­é—®é¢˜:

1. leaderé€‰ä¸¾
2. æ—¥å¿—å¤åˆ¶
3. å®‰å…¨æ€§ä¿è¯

åœ¨ä»»æ„æ—¶åˆ»,ä¸€ä¸ªserverå¤„äºä¸‰ç§çŠ¶æ€ä¹‹ä¸€:

1. leader
2. candidate
3. follower

ä»»ä½•æ—¶åˆ»,æ•´ä¸ªé›†ç¾¤ä¸­,æœ‰ä¸”åªæœ‰ä¸€ä¸ªleader,è¿™ä¸€ç‚¹åœ¨åé¢ä¼šè°ˆåˆ°å¦‚ä½•å®ç°.

**follower**çš„å·¥ä½œååˆ†ç®€å•:ä»–ä»¬ä¸å‘å‡ºä»»ä½•request,åªç®€å•çš„å›å¤æ¥è‡ªcandidateå’Œleaderçš„ä¿¡æ¯.**leader**å¤„ç†æ‰€æœ‰æ¥è‡ªclientçš„request(å¦‚æœä¸€ä¸ªclientè”ç³»äº†follower,followerè½¬å‘ç»™leader).**candidate**ç”¨æ¥é€‰ä¸¾æ–°çš„leader.

ä»–ä»¬çš„è½¬æ¢å…³ç³»ä¸º:å¯åŠ¨æ—¶,æ‰€æœ‰serveréƒ½ä¸ºfollower.å½“ä¸€ä¸ªfollowerå‘ç°è¶…è¿‡election timeåæ²¡æœ‰æ”¶åˆ°leaderçš„å¿ƒè·³ä¿¡æ¯,åˆ™å¼€å¯æ–°çš„term,å‘èµ·é€‰ä¸¾,å˜ä¸ºcandidate.candidateåœ¨é€‰ä¸¾æ—¶é—´ç»“æŸåä»æ²¡æœ‰æ”¶åˆ°leaderçš„ä¿¡æ¯,åˆ™ç»§ç»­ä¿æŒé€‰ä¸¾,è‹¥æ”¶åˆ°,åˆ™å˜ä¸ºfollower.ä¸€ä¸ªcandidateæ”¶åˆ°å¤šæ•°serverçš„æŠ•ç¥¨å,è½¬æ¢ä¸ºleader.leaderå‘ç°ä¸€ä¸ªserverçš„termå¤§äºè‡ªå·±å,è½¬æ¢ä¸ºfollower.

![[2-source-material/images/Pasted image 20251014091948.png]]

raftå°†æ—¶é—´åˆ’åˆ†ä¸ºä»»æ„é•¿åº¦çš„term(ä»»æœŸ).æ¯ä¸ªä»»æœŸä¼´éšç€ä¸€ä¸ªå”¯ä¸€çš„é€’å¢æ•´æ•°.æ¯ä¸ªä»»æœŸå¼€å§‹æ—¶,é›†ç¾¤ä¼šè¿›è¡Œé€‰ä¸¾,ä»candidateé€‰å‡ºä¸€ä¸ªleader.å¦‚æœäº§ç”Ÿsplit vote,è¯¥termæ²¡æœ‰leader,ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªterm,é‡æ–°å¼€å§‹é€‰ä¸¾.

![[2-source-material/images/Pasted image 20251014092120.png]]

ä¸åŒçš„æœåŠ¡å™¨å¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´è§‚å¯Ÿåˆ°termä¿¡æ¯,å› æ­¤å¯èƒ½å‡ºç°leaderè¿‡æœŸçš„æƒ…å†µ.å› æ­¤termèµ·åˆ°ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿçš„æ•ˆæœ,æ¯ä¸ªserverå­˜å‚¨ä¸€ä¸ªcurrent termå·,éšç€æ—¶é—´å•è°ƒé€’å¢.å½“serverä¹‹é—´äº¤äº’æ—¶,ä¼šäº¤æ¢å½¼æ­¤çš„ä»»æœŸå·,å¦‚æœä¸€ä¸ªserverå‘ç°è‡ªå·±ä»»æœŸå·å°äºå…¶ä»–çš„,åˆ™æ›´æ–°ä¸ºæ›´å¤§çš„å€¼.å¦‚æœä¸€ä¸ªcandidateæˆ–è€…leaderå‘ç°è‡ªå·±çš„termè¿‡æœŸäº†,åˆ™ç«‹åˆ»å›é€€ä¸ºfollowerçŠ¶æ€.å¦‚æœä¸€ä¸ªserveræ”¶åˆ°ä¸€ä¸ªè¿‡æœŸtermçš„serverçš„è¯·æ±‚,åˆ™æ‹’ç»è¯¥è¯·æ±‚.

Raftä½¿ç”¨åˆ°ä¸¤ä¸ªRPC.

RequestVote RPCåœ¨é€‰ä¸¾é˜¶æ®µç”±candidateå‘èµ·,AppendEntries RPCåªèƒ½ç”±leaderå‘é€,ç”¨äºå¤åˆ¶log,ä¹Ÿç”¨ä½œå¿ƒè·³.RPCè¿‡æœŸçš„è¯,åˆ™serveré‡å‘.serverå¹¶è¡Œå‘é€RPC.

åœ¨è®¨è®ºleaderé€‰ä¸¾,æ—¥å¿—å¤åˆ¶,å®‰å…¨æ€§,é¦–å…ˆä»‹ç»raftä¿è¯çš„æ€§è´¨:

1. election safety:åœ¨ä¸€ä¸ªtermå†…,æœ€å¤šåªæœ‰ä¸€ä¸ªleader
2. leader append-only:ä¸€ä¸ªleaderä»ä¸è¦†å†™æˆ–è€…åˆ é™¤è‡ªå·±çš„log,åªappendæ–°çš„entry.
3. log matching:å¦‚æœä¸¤ä¸ªlogæœ‰ç›¸åŒçš„indexå’Œterm,é‚£ä¹ˆåœ¨ç»™å®šindexå‰çš„æ‰€æœ‰entryéƒ½ç›¸åŒ
4. leader completeness:å¦‚æœä¸€ä¸ªlog entryåœ¨ä¸€ä¸ªtermå†…è¢«**committed**,é‚£ä¹ˆè¯¥entryåœ¨ä¹‹åçš„æ‰€æœ‰termä¸­,éƒ½ä¼šåœ¨leaderéƒ½logä¸­
5. state machine safety:å¦‚æœä¸€ä¸ªserveræŠŠæŸä¸ªindexçš„log entryåº”ç”¨åˆ°çŠ¶æ€æœºä¸Š(committed),é‚£ä¹ˆè¯¥indexå¤„ä¸ä¼šæœ‰å…¶ä»–çš„log entry

## Leader election

rafté‡‡ç”¨å¿ƒè·³æœºåˆ¶æ¥è§¦å‘leaderé€‰ä¸¾.å½“serverå¯åŠ¨æ—¶,å‡ä¸ºfollowerçŠ¶æ€.ä¸€ä¸ªserveråªè¦æ”¶åˆ°æ¥è‡ªleaderæˆ–è€…candidateçš„message,å°±ä¿æŒfollowerçŠ¶æ€.leaderå‘¨æœŸæ€§åœ°å‘é€å¿ƒè·³(ä¸åŒ…å«log entryçš„appendEntriesRPC),æ¥ç»´æŒè‡ªå·±çš„åœ°ä½.å¦‚æœä¸€ä¸ªfolloweråœ¨election timeoutå,æ²¡æœ‰æ”¶åˆ°ä¿¡æ¯,å°±å‡è®¾æ²¡æœ‰å¯è§çš„leader,å®ƒå‘èµ·é€‰ä¸¾.

followerå‘èµ·é€‰ä¸¾çš„è¿‡ç¨‹æ˜¯:

1. å¢åŠ è‡ªå·±current term
2. è½¬æ¢ä¸ºcandidate
3. ç»™è‡ªå·±æŠ•ç¥¨
4. å¹¶è¡Œå‘å…¶ä»–é›†ç¾¤ä¸­çš„serverå‘é€RPC

ä¸€ä¸ªcandidateæŒç»­å¤„ç†è¯¥çŠ¶æ€ç›´åˆ°ä¸‹é¢ä¸‰ä¸ªäº‹ä»¶ä¹‹ä¸€å‘ç”Ÿ:

1. èµ¢å¾—é€‰ä¸¾
2. å…¶ä»–serveræˆä¸ºleader
3. è¶…æ—¶,è€Œä¸”æ²¡æœ‰leaderäº§ç”Ÿ.

*èµ¢å¾—é€‰ä¸¾*:å½“candidateæ”¶åˆ°é›†ç¾¤ä¸­å¤§å¤šæ•°serverçš„voteå,èµ¢å¾—é€‰ä¸¾.æ¯ä¸ªserveræœ€å¤šç»™ä¸€ä¸ªcandidateæŠ•ç¥¨,é‡‡ç”¨å…ˆåˆ°å…ˆå¾—çš„æ–¹å¼.ä¿è¯äº†æœ€å¤šåªæœ‰ä¸€ä¸ªcandidateå¯ä»¥èµ¢å¾—é€‰ä¸¾.å½“ä¸€ä¸ªcandidateèµ¢å¾—é€‰ä¸¾å,å®ƒå‘å…¶ä»–serverå‘é€å¿ƒè·³,å£°æ˜è‡ªå·±çš„leaderåœ°ä½,é¿å…æ–°çš„é€‰ä¸¾

*å…¶ä»–serveræˆä¸ºleader*:åœ¨candidateç­‰å¾…voteçš„æ—¶å€™,å¯èƒ½æ”¶åˆ°å…¶ä»–serverçš„å¿ƒè·³ä¿¡æ¯,å³å½“é€‰leaderå£°æ˜.å¦‚æœå…¶termå¤§äºç­‰äºå½“å‰candidateçš„term,åˆ™candidateå˜ä¸ºfollower;å¦åˆ™,candidateæ‹’ç»æ­¤rpc,ä¿æŒcandidateçŠ¶æ€

*è¶…æ—¶*:å¦‚æœå¤šä¸ªfolloweråŒæ—¶æˆä¸ºcandidate,åˆ™ä¼šäº§ç”Ÿsplit vote,å› ä¸ºæ²¡æœ‰candidateè·å¾—å¤§å¤šæ•°serverçš„æŠ•ç¥¨,è¿™ç§æƒ…å†µä¸‹,ä¼šäº§ç”Ÿelection timeout,å¹¶å¼€å§‹æ–°ä¸€è½®çš„é€‰ä¸¾.æœ€åæƒ…å†µä¸‹,è¿™ç§æƒ…å†µä¼šæŒç»­å‘ç”Ÿ.è§£å†³æ–¹å¼æ˜¯:ä½¿ç”¨éšæœºelection timeouts.æ¯ä¸ªserveréšæœºåœ¨150-300mså†…é€‰å–election timeouts.

## Log replication

å½“leaderè¢«é€‰ä¸¾å,å®ƒå¼€å§‹å¤„ç†clientçš„è¯·æ±‚,æ¯ä¸ªclientè¯·æ±‚åŒ…å«ä¸€ä¸ªcommand, leaderå°†è¯¥commandè¿½åŠ åˆ°è‡ªå·±çš„logä¸­ä½œä¸ºä¸€ä¸ªnew entry.ç„¶åå‘å…¶ä»–serverå‘é€AppendEntries RPC,å½“è¯¥logè¢«å¤§å¤šæ•°serverå¤åˆ¶å,leader commitæ­¤log.å¦‚æœä¸€ä¸ªserverå› ä¸ºç½‘ç»œé—®é¢˜æ²¡æœ‰æˆåŠŸå¤åˆ¶,åˆ™leaderæ— é™é‡å¤å‘é€.

Log entryçš„ç»„ç»‡å½¢å¼ä¸º:ä¸€ä¸ªçŠ¶æ€æœºå‘½ä»¤,ä¸€ä¸ªtermå·.åŒæ—¶,ä¸€ä¸ªentryè¿˜æœ‰ä¸€ä¸ªindex,å†³å®šå…¶åœ¨logä¸­çš„ä½ç½®.

Raftä¿è¯,ä¸€ä¸ªcommittedçš„entryä¼šæŒä¹…åŒ–,æœ€ç»ˆæ¯ä¸ªserverä¸Šéƒ½ä¼šå°†è¯¥entryåº”ç”¨åˆ°çŠ¶æ€æœº.å½“å¤§å¤šæ•°serverå¤åˆ¶äº†ä¸€ä¸ªentryå,leader commitæ­¤entry,å¹¶ä¸”ä¹Ÿä¼šcommitæ‰€æœ‰ä¹‹å‰çš„log entries,åŒ…æ‹¬å…¶ä»–leaderåˆ›å»ºçš„entries.å½“å‘ç”Ÿleaderæ›´æ¢å,éœ€è¦é¢å¤–çš„è§„åˆ™,ä¸‹é¢ä¼šè®¨è®º.leaderä¼šç»´æŠ¤ä¸€ä¸ªè‡ªå·±ä¸€ç›´çš„æœ€é«˜çš„å°†è¦è¢«commitçš„indexå·,å¹¶åœ¨AppendEntries RPCsä¸­åŒ…å«æ­¤å·.å½“followerå‘ç°ä¸€ä¸ªlog entryè¢«committedå,ä¼šæŠŠè¯¥entryåº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­.

Raftä¿è¯ä¸‹é¢ä¸¤ä¸ªæ€§è´¨,å…±åŒæ„æˆäº†log matchingçš„æ€§è´¨:

1. å¦‚æœä¸¤ä¸ªä¸åŒlogä¸­çš„entriesæœ‰ç›¸åŒçš„indexå’Œterm,é‚£ä¹ˆä»–ä»¬å­˜å‚¨çš„commandç›¸åŒ(ä¹Ÿå°±æ˜¯è¯´ä¸åŒserverçš„logä¸­,åŒä¸€ä¸ªä½ç½®,åŒä¸€ä»»æœŸçš„log entryæ˜¯ä¸€æ ·çš„)
2. åŒæ ·çš„æ¡ä»¶ä¸‹,åœ¨å½“å‰è¿™ä¸ªç›¸åŒçš„indexå‰çš„æ‰€æœ‰entrieséƒ½ç›¸åŒ.

ç¬¬ä¸€ä¸ªæ€§è´¨:leaderåœ¨ä¸€ä¸ªç»™å®šçš„termå’Œindexä¸‹,åªä¼šåˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„entry.

ç¬¬äºŒä¸ªæ€§è´¨:ä¾é AppendEntries RPCæ£€æŸ¥,leaderåœ¨logä¸­åŒ…å«æ–°entryä¹‹å‰çš„é‚£ä¸€ä¸ªentryçš„indexå’Œterm.å¦‚æœfollowerçš„logä¸­æ²¡æœ‰è¿™ä¸ªindexå’Œtermçš„entry,åˆ™followeræ‹’ç»è¯¥æ–°entry.è¿™ä¸ªconsistency checkæ˜¯ä¸€ä¸ªé€’å½’çš„æ­¥éª¤.

å½“ä¸€åˆ‡æ­£å¸¸æ—¶,leaderå’Œfollowerçš„logæ˜¯ä¸€è‡´çš„.leaderå®•æœºå¯èƒ½ä¼šå¯¼è‡´logçš„ä¸ä¸€è‡´(old leaderè¿˜æ²¡æ¥å¾—åŠå¤åˆ¶å®ƒçš„å…¨éƒ¨æ—¥å¿—),å½“é¢‘ç¹å‘ç”Ÿæ—¶,å¯èƒ½å¯¼è‡´followerç¼ºå°‘leaderä¸­çš„entry,ä¹Ÿå¯èƒ½åŒ…å«leaderä¸­æ²¡æœ‰çš„entry.

Raftçš„è§£å†³æ–¹å¼æ˜¯:leaderå¼ºåˆ¶followerçš„logå’Œè‡ªå·±ç›¸åŒ.å³:å¦‚æœfollowerçš„logå’Œè‡ªå·±æœ‰å†²çª,åˆ™è¦†å†™followerçš„log.

æ­¥éª¤:

1. æ‰¾åˆ°leaderå’Œfollowerç›¸åŒçš„log entry
2. åˆ é™¤followerä¸­è¯¥entryåçš„éƒ¨åˆ†
3. leaderå‘é€è¯¥ç‚¹åçš„æ‰€æœ‰entry

è¿™äº›æ­¥éª¤ä»…é€šè¿‡AppendEntries RPCå®Œæˆ.leaderä¸ºæ¯ä¸ªfollowerç»´æŠ¤ä¸€ä¸ªnextIndex ,ä»£è¡¨leaderå°†è¦å‘é€ç»™followerçš„ä¸‹ä¸€ä¸ªentryçš„index.å½“ä¸€ä¸ªcandidateå½“é€‰leaderå,ä»–æŠŠæ‰€æœ‰followerçš„nextIndexè®¾ç½®ä¸ºå®ƒlogçš„æœ€åä¸€ä½çš„ä¸‹ä¸€ä¸ªæ•°å­—.

å¦‚æœfollowerçš„logå’Œleaderä¸ç›¸åŒ,åˆ™AppendEntries RPCè¿”å›å¤±è´¥,leaderä¼šé€’å‡nextIndexå†å‘é€,è¿™æ ·æŒç»­ä¸‹å»,å°±ä¼šæ‰¾åˆ°matching point.æ‰¾åˆ°å,è¿½åŠ æ—¥å¿—ä¿¡æ¯(æ³¨æ„,è¿™é‡Œæ˜¯è¿½åŠ matching pointåçš„å…¨éƒ¨æ—¥å¿—,ä¸æ˜¯ä¸€æ¡ä¸€æ¡åœ°è¿½åŠ )

è¿™ç§æœºåˆ¶è®©leaderä¸éœ€è¦é¢å¤–çš„æœºåˆ¶å°±å¯ä»¥ä¿è¯ä¸€è‡´æ€§.leaderæ°¸è¿œä¸è¦†å†™æˆ–è€…åˆ é™¤è‡ªå·±çš„æ—¥å¿—.

## Safety

ä¸Šè¿°æœºåˆ¶ä¸èƒ½ä¿è¯æ¯ä¸ªserverçš„çŠ¶æ€æœºæŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„å‘½ä»¤.

æ¯”å¦‚è¯´:ä¸€ä¸ªfolloweråœ¨leader commit log entryæ—¶å®•æœºäº†,ä½†æ˜¯ä¹‹åå®ƒåˆè¢«é€‰ä¸¾ä¸ºleader,è¿™ä¼šå¯¼è‡´å·²ç»commitçš„è®°å½•ä¸¢å¤±.

### Election restriction

Raftä¸­log entryåªæœ‰ä¸€ä¸ªæµå‘:leader to follower

åœ¨é€‰ä¸¾é˜¶æ®µ,ä¸€ä¸ªcandidateå¿…é¡»åŒ…å«æ‰€æœ‰å·²ç»committedçš„log entriesæ‰èƒ½å¤Ÿè¢«é€‰ä¸¾.ä¸€ä¸ªcandidateå¿…é¡»å’Œé›†ç¾¤ä¸­çš„å¤§å¤šæ•°äº¤æµæ¥è·å¾—é€‰ç¥¨,æ„å‘³ç€æ¯ä¸ªcommitted entryä¸€å®šä¼šåœ¨è‡³å°‘ä¸€ä¸ªserverä¸­æœ‰.

RequestVote RPCæœ‰ä¸€ä¸ªæœºåˆ¶:RPCåŒ…å«candidateçš„logä¿¡æ¯,å¦‚æœvoterå‘ç°è‡ªå·±çš„log**æ›´æ–°**,åˆ™æ‹’ç»æŠ•ç¥¨.

*æ›´æ–°*:ä¸¤ä¸ªlogæ¯”è¾ƒ,å¦‚æœæœ€åä¸€ä¸ªentryçš„termä¸åŒ,termå¤§çš„æ›´æ–°.å¦‚æœtermç›¸åŒ,åˆ™è°çš„logæ›´é•¿è°æ›´æ–°

### Committing entries from previous terms

leaderçŸ¥é“ä¸€ä¸ªentryè¢«committed,å¦‚æœè¯¥entryè¢«å¤§å¤šæ•°serverå¤åˆ¶.å¦‚æœleaderåœ¨commitä¹‹å‰æŒ‚äº†,åæ¥çš„leaderä¼šå°è¯•å®Œæˆå¤åˆ¶è¯¥entry.ä½†æ˜¯,ä¸€ä¸ªleaderä¸èƒ½ç«‹åˆ»æäº¤å‰ä¸€ä¸ªä»»æœŸå†…çš„entry,å³ä½¿è¢«å¤§å¤šæ•°serverå¤åˆ¶.å®ƒåªèƒ½åœ¨è‡ªå·±çš„ä»»æœŸå†…,åœ¨ä¸‹ä¸€æ¬¡æäº¤æ—¶,é¡ºå¸¦åœ°æŠŠå‰ä¸€ä¸ªtermçš„entryæäº¤äº†.ä¸€ä¸ªä¾‹å­å¦‚ä¸‹:

![[2-source-material/images/Pasted image 20251014120834.png]]

S1å¼€å§‹æ˜¯leader,å¤åˆ¶äº†index 2.åœ¨bæ—¶åˆ»,s1å®•æœº,s5æ¥ç®¡(s3,s4æŠ•ç¥¨),åœ¨index 2 æ”¶åˆ°ä¸€ä¸ªä¸åŒçš„entry.cæ—¶åˆ»,s5å®•æœº,s1é‡æ–°å½“é€‰ä¸ºleader(s2,s3,s4æŠ•ç¥¨),å¼€å§‹term4,å¹¶ç»§ç»­å¤åˆ¶index 2çš„entry,æ­¤æ—¶index 2çš„entryå·²ç»åœ¨å¤§å¤šæ•°serverä¸Šäº†,ä½†æ˜¯è¿˜æ²¡s1è¿˜æ²¡æ¥çš„åŠæäº¤index 3,å°±åˆå®•æœºäº†.ç„¶ås5å†æ¬¡æˆä¸ºleader,å¤åˆ¶è‡ªå·±çš„entry,è¿™ä¼šè¦†å†™index 2å¤„çš„æ—¥å¿—.

å¦‚æœs1åœ¨æˆä¸ºleaderå¹¶å¤åˆ¶äº†å¤§å¤šæ•°entryåå°±åœ¨æäº¤4ä¹‹å‰æäº¤2,é‚£ä¹ˆä¼šå¯¼è‡´å·²æäº¤çš„entryè¢«è¦†å†™,é€ æˆä¸å®‰å…¨.

Raftçš„è§£å†³æ–¹æ¡ˆæ˜¯:leaderåªèƒ½æäº¤å½“å‰termçš„entry.æ ¹æ®log matchingæ€§è´¨,æ­¤å‰çš„entryä¹Ÿä¼šåŒ¹é….

### Follower and candidate crashes

followeræˆ–è€…candidateå®•æœºå,rpcä¼šå¤±æ•ˆ,Raftæ— é™é‡è¯•.

å¦‚æœä¸€ä¸ªserveræ”¶åˆ°äº†rpcå¹¶æ‰§è¡Œå®Œæˆåå®•æœºäº†,æ²¡æœ‰å‘é€è¿”å›ä¿¡å·,å½“å®ƒé‡å¯æ—¶,ç”±äºRaftçš„rpcæ˜¯å¹‚ç­‰çš„,æ‰€ä»¥æ²¡å½±å“.

### Timing and availability

åœ¨election timeout,ä¼ æ’­æ—¶å»¶(broadcastTime)å’ŒMTBF(mean time between failures)ä¹‹é—´,éœ€è¦æœ‰å¤§å°å…³ç³»:

$$
broadcastTime \ll electionTimeout \ll MTBF
$$

å¾ˆå¥½ç†è§£,rpcä¿¡å·å¿…é¡»è¦åœ¨è¶…æ—¶ä¹‹å‰æ”¶åˆ°,å¦åˆ™ä¼šä¸€ç›´é€‰ä¸¾.

Raftè¦æ±‚æŠŠä¿¡æ¯å­˜å‚¨åˆ°åº•å±‚å­˜å‚¨ä¸­,æ‰€ä»¥broadcast timeé€šå¸¸ä¸º0.5ms-20ms
election timeoutåœ¨10ms-500msä¹‹é—´.MTBFé€šå¸¸ä¸ºå‡ ä¸ªæœˆ.

## Log Compaction

æ—¥å¿—ä¸èƒ½æ— é™å¢é•¿.é‡‡ç”¨snapshotæ¥å‹ç¼©æ—¥å¿—

snapshotå½“å‰çŠ¶æ€åˆ°ç£ç›˜,ç„¶ååˆ é™¤è¯¥ç‚¹å‰çš„æ‰€æœ‰æ—¥å¿—

![[2-source-material/images/Pasted image 20251019155313.png]]

å‹ç¼©äº†æ—¥å¿—1-5çš„ç»“æœ

æ¯ä¸ªserveråšè‡ªå·±çš„snapshot,åŒ…æ‹¬å½“å‰çš„çŠ¶æ€æœºçŠ¶æ€,ä»¥åŠä¸€äº›å…ƒä¿¡æ¯.

leaderéœ€è¦å¶å°”å‘è½åçš„followerå‘é€snapshot,è¿™ç§æƒ…å†µåªåœ¨followerå¾ˆæ…¢,æˆ–è€…æ–°serveråŠ å…¥çš„æƒ…å†µ.

leaderä½¿ç”¨ä¸€ä¸ªæ–°çš„RPCæ¥å‘é€snapshot--InstallSnapshot.

å½“followeræ”¶åˆ°snapshotå,åš:
1. å¦‚æœsnapshotä¸­æœ‰followerä¸­æ²¡æœ‰çš„æ–°ä¿¡æ¯,followeræŠ›å¼ƒè‡ªå·±çš„æ‰€æœ‰æ—¥å¿—,åº”ç”¨snapshot.
2. å¦‚æœsnapshotæ˜¯followeræ—¥å¿—çš„ä¸€ä¸ªå‰ç¼€,åˆ™å‹ç¼©snapshotéƒ¨åˆ†,åç»§ä¿æŒ

å½±å“snapshotçš„æ€§èƒ½å› ç´ :

1. serverå¿…é¡»å†³å®šä½•æ—¶è¿›è¡Œsnapshot,å¤ªçŸ­æµªè´¹ç£ç›˜IO,å¤ªä¹…å¯¼è‡´æ—¥å¿—è¿‡å¤§,è€Œä¸”å¢åŠ é‡å¯æ—¶åº”ç”¨æ—¥å¿—çš„æ—¶é—´.*ç­–ç•¥æ˜¯é€‰æ‹©ä¸€ä¸ªå›ºå®šsize,æ—¥å¿—è¾¾åˆ°æ­¤sizeå,è¿›è¡Œå‹ç¼©*
2. å†™snapshotä¼šè€—è´¹å¤§é‡æ—¶é—´,æˆ‘ä»¬ä¸å¸Œæœ›è¿™å¯¹æ™®é€šæ“ä½œé€ æˆå»¶è¿Ÿ,*é‡‡ç”¨å†™æ—¶å¤åˆ¶*æ¥ä¼˜åŒ–.

## Client interaction

clientå¼€å§‹å…ˆå‘éšæœºçš„serverå‘é€è¯·æ±‚,å¦‚æœå¯¹æ–¹ä¸æ˜¯leader,åˆ™è¯·æ±‚è¢«è½¬å‘ç»™leader,å¹¶ä¸”é€šçŸ¥client leaderçš„ip.

ä¸ºé˜²æ­¢å‡ºç°,leaderæäº¤äº†clientçš„è¯·æ±‚,ä½†æ˜¯åœ¨å›å¤clientå‰å®•æœº,å¯¼è‡´clienté‡å‘,åŒä¸€å‘½ä»¤æ‰§è¡Œä¸¤æ¬¡çš„æƒ…å†µ,è§„å®šæ¯ä¸ªclientçš„æ“ä½œéœ€è¦åŠ ä¸Šåºåˆ—å·.

åªè¯»æ“ä½œä¹Ÿéœ€è¦é¢å¤–æ“ä½œæ¥é˜²æ­¢è¯»å–åˆ°è¿‡æœŸæ•°æ®,è¿™å‡ºç°åœ¨ç½‘ç»œåˆ†åŒºä¸­old leaderå¹¶ä¸çŸ¥é“æ–°leaderå·²ç»äº§ç”Ÿçš„æƒ…å†µä¸‹.

1. leaderå¿…é¡»æ‹¥æœ‰æ‰€æœ‰å·²æäº¤çš„entriesä¿¡æ¯,ä½†æ˜¯åœ¨å…¶termå¼€å§‹æ—¶,ä»–ä¸èƒ½ç¡®å®šå“ªäº›æ˜¯å·²æäº¤çš„entrieså“ªäº›ä¸æ˜¯,æ‰€ä»¥,leaderåœ¨å…¶termå¼€å§‹æ—¶,éœ€è¦è¿›è¡Œä¸€ä¸ªç©ºæäº¤(no-op),æ¥æäº¤å…¶å‰é¢çš„æ—¥å¿—.

2. leaderåœ¨æ‰§è¡Œåªè¯»æ“ä½œå‰,éœ€è¦å’Œé›†ç¾¤å¤§å¤šæ•°äº¤æ¢å¿ƒè·³ä¿¡æ¯æ¥ç¡®è®¤è‡ªå·±çš„leaderåœ°ä½.è¿™æ˜¯Raftæƒ³è¦å®ç°çº¿æ€§ä¸€è‡´æ€§çš„è¦æ±‚,æ¯«æ— ç–‘é—®é™ä½äº†æ€§èƒ½.åœ¨å®é™…ä¸­éœ€è¦åštrade-off,åŸºæœ¬é€‰æ‹©å‡†ç¡®æ€§æ¢æ€§èƒ½
## Reference

[[2-source-material/papers/raft.pdf|raft]]